publish:
    name: Publicar na PSGallery
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: Publicar Modulo
        shell: pwsh
        env:
          PSG_KEY: ${{ secrets.PSGALLERY_API_KEY }}
        run: |
          $ErrorActionPreference = "Stop"
          
          # For√ßa seguran√ßa e registra o reposit√≥rio silenciosamente
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
          Set-PSRepository -Name PSGallery -InstallationPolicy Trusted

          # O SEGREDO: O Publish-Module no PWSH 7 j√° tenta baixar o NuGet 
          # automaticamente se voc√™ n√£o travar ele com comandos de instala√ß√£o manuais.
          Write-Host "üöÄ Iniciando publica√ß√£o direta da vers√£o..."
          $modulePath = Resolve-Path "./src/PoshAutomator"
          
          Publish-Module -Path $modulePath -NuGetApiKey $env:PSG_KEY -Verbose -Force