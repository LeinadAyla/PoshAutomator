name: Deploy PoshAutomator
on:
  push:
    branches: [ main ]

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Publicar Modulo
        shell: pwsh
        env:
          # ATENÇÃO: Verifique se o nome no GitHub Secrets é exatamente este:
          PSG_KEY: ${{ secrets.PSGALLERY_API_KEY }}
        run: |
          $ErrorActionPreference = "Stop"
          
          # 1. Validação de segurança do Secret
          if ([string]::IsNullOrWhiteSpace($env:PSG_KEY)) {
              Write-Error "ERRO: PSG_KEY está vazia. Verifique se o Secret 'PSGALLERY_API_KEY' existe no GitHub."
              exit 1
          }

          # 2. O caminho correto baseado no seu comando 'tree'
          $modulePath = "./src/PoshAutomator"

          Write-Host "==== VERIFICANDO ESTRUTURA ===="
          if (Test-Path $modulePath) {
              Get-ChildItem -Path $modulePath
          } else {
              Write-Error "ERRO: Pasta $modulePath não encontrada!"
              exit 1
          }

          # 3. Publicação
          Write-Host "==== PUBLICANDO NA PS GALLERY ===="
          Publish-Module -Path $modulePath -NuGetApiKey $env:PSG_KEY -Verbose -Force