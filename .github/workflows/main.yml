name: CI-CD PoshAutomator
on:
  push:
    branches: [ main ]

jobs:
  test:
    name: Executar Testes Pester
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4
      - name: Rodar Testes
        shell: pwsh
        run: |
          Install-Module -Name Pester -Force -SkipPublisherCheck -Scope CurrentUser
          $config = New-PesterConfiguration
          $config.Run.Path = "./tests"
          $config.Run.Exit = $true
          Invoke-Pester -Configuration $config

  publish:
    name: Publicar na PSGallery
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: Publicar Modulo
        shell: pwsh
        env:
          PSG_KEY: ${{ secrets.PSGALLERY_API_KEY }}
        run: |
          $ErrorActionPreference = "Stop"
          
          # 1. For√ßa o uso de protocolos seguros
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

          # 2. Configura a Galeria como confi√°vel (Isso permite baixar o NuGet automaticamente)
          Write-Host "üì° Configurando reposit√≥rio..."
          Set-PSRepository -Name PSGallery -InstallationPolicy Trusted

          # 3. Resolve o caminho do m√≥dulo
          $modulePath = Resolve-Path "./src/PoshAutomator"
          
          Write-Host "üöÄ Iniciando publica√ß√£o direta da vers√£o..."
          
          # 4. Publica√ß√£o Oficial: O Force garante que ele tente instalar o NuGet se necess√°rio
          try {
              Publish-Module -Path $modulePath -NuGetApiKey $env:PSG_KEY -Verbose -Force
              Write-Host "‚úÖ Sucesso absoluto!"
          } catch {
              Write-Error "‚ùå Falha na publica√ß√£o: $($_.Exception.Message)"
              exit 1
          }