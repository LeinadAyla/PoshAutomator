name: CI-CD PoshAutomator
on:
  push:
    branches: [ main ]

jobs:
  test:
    name: Executar Testes Pester
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4
      - name: Rodar Testes
        shell: pwsh
        run: |
          Install-Module -Name Pester -Force -SkipPublisherCheck -Scope CurrentUser
          $config = New-PesterConfiguration
          $config.Run.Path = "./tests"
          $config.Run.Exit = $true
          Invoke-Pester -Configuration $config

  publish:
    name: Publicar na PSGallery
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: Publicar via NuGet Direct
        shell: pwsh
        env:
          PSG_KEY: ${{ secrets.PSGALLERY_API_KEY }}
        run: |
          $ErrorActionPreference = "Stop"
          
          # 1. Garante TLS 1.2 e baixa o NuGet.exe diretamente
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
          Invoke-WebRequest -Uri "https://dist.nuget.org/win-x86-commandline/latest/nuget.exe" -OutFile "./nuget.exe"
          
          # 2. Identifica a vers√£o atual para o log
          $manifest = Import-PowerShellDataFile "./src/PoshAutomator/PoshAutomator.psd1"
          $version = $manifest.ModuleVersion
          Write-Host "üì¶ Empacotando e enviando vers√£o $version via API direta..."

          # 3. Publica√ß√£o direta usando NuGet (Pula o erro de PackageProvider)
          # Nota: No Linux, usamos o 'mono' para rodar o nuget.exe ou chamamos diretamente se o runner permitir
          chmod +x ./nuget.exe
          ./nuget.exe push "./src/PoshAutomator" $env:PSG_KEY -Source "https://www.powershellgallery.com/api/v2/package" -NonInteractive