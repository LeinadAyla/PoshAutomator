name: Deploy PoshAutomator
on:
  push:
    branches: [ main ]

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: Publicar Modulo
        shell: pwsh
        env:
          # Garanta que o nome no GitHub Secrets seja exatamente este
          PSG_KEY: ${{ secrets.PSGALLERY_API_KEY }}
        run: |
          $ErrorActionPreference = "Stop"

          Write-Host "==== DEBUG WORKSPACE ===="
          Get-Location
          # Lista arquivos recursivamente para confirmar a estrutura
          Get-ChildItem -Recurse

          # 1Ô∏è‚É£ Validar Secret
          if ([string]::IsNullOrWhiteSpace($env:PSG_KEY)) {
              throw "ERRO: PSG_KEY est√° vazia. Verifique o Secret PSGALLERY_API_KEY nas configura√ß√µes do reposit√≥rio."
          }

          # 2Ô∏è‚É£ Caminho do m√≥dulo (Baseado no seu comando tree)
          $modulePath = "./src/PoshAutomator"

          if (-not (Test-Path $modulePath)) {
              throw "ERRO: Caminho $modulePath n√£o encontrado no workspace."
          }

          # 3Ô∏è‚É£ Garantir NuGet Provider (Necess√°rio para comunica√ß√£o com a Galeria)
          Write-Host "Configurando provedor NuGet..."
          if (-not (Get-PackageProvider -Name NuGet -ErrorAction SilentlyContinue)) {
              Install-PackageProvider -Name NuGet -MinimumVersion 2.8.5.201 -Force
          }

          # 4Ô∏è‚É£ Garantir PSGallery registrada e confi√°vel
          Write-Host "Configurando reposit√≥rio PSGallery..."
          if (-not (Get-PSRepository -Name PSGallery -ErrorAction SilentlyContinue)) {
              Register-PSRepository -Default
          }
          Set-PSRepository -Name PSGallery -InstallationPolicy Trusted

          # 5Ô∏è‚É£ Publicar
          Write-Host "üöÄ Publicando m√≥dulo na PowerShell Gallery..."
          Publish-Module `
              -Path $modulePath `
              -NuGetApiKey $env:PSG_KEY `
              -Verbose `
              -Force

          Write-Host "‚úÖ Publica√ß√£o conclu√≠da com sucesso!"