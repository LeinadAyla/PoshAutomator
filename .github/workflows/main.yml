publish:
    name: Publicar na PSGallery
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do c칩digo
        uses: actions/checkout@v4

      - name: Publicar Modulo
        shell: pwsh
        env:
          PSG_KEY: ${{ secrets.PSGALLERY_API_KEY }}
        run: |
          $ErrorActionPreference = "Stop"
          
          # 1. Configura칞칚o de TLS e Reposit칩rio
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
          Register-PSRepository -Default -ErrorAction SilentlyContinue

          # 2. Instala칞칚o do NuGet SEM busca (ignora o erro de 'No match found')
          Write-Host "游닍 For칞ando instala칞칚o do provedor NuGet..."
          Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
          
          # Tenta instalar silenciosamente; se falhar, o Publish-Module tentar치 baixar automaticamente
          Install-PackageProvider -Name NuGet -MinimumVersion 2.8.5.201 -Force -Confirm:$false -ErrorAction SilentlyContinue

          # 3. Publica칞칚o Oficial
          $modulePath = Resolve-Path "./src/PoshAutomator"
          Write-Host "游 Publicando vers칚o oficial na PowerShell Gallery..."
          
          # O par칙metro -Force aqui 칠 vital para ignorar avisos de ambiente
          Publish-Module -Path $modulePath -NuGetApiKey $env:PSG_KEY -Verbose -Force