name: Deploy PoshAutomator
on:
  push:
    branches: [ main ]

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: Publicar Modulo
        shell: pwsh
        env:
          # O nome aqui deve ser EXATAMENTE o que est√° no seu GitHub Secrets
          PSG_KEY: ${{ secrets.PSGALLERY_API_KEY }}
        run: |
          $ErrorActionPreference = "Stop"

          Write-Host "==== DEBUG WORKSPACE ===="
          Get-Location
          # Isso vai mostrar onde os arquivos realmente est√£o no servidor
          Get-ChildItem -Recurse 

          # 1Ô∏è‚É£ Validar Secret
          if ([string]::IsNullOrWhiteSpace($env:PSG_KEY)) {
              throw "ERRO: PSG_KEY est√° vazia. Verifique o Secret 'PSGALLERY_API_KEY' no GitHub."
          }

          # 2Ô∏è‚É£ Caminho do m√≥dulo baseado no seu comando 'tree'
          $modulePath = "./src/PoshAutomator"

          if (-not (Test-Path $modulePath)) {
              throw "ERRO: Caminho $modulePath n√£o encontrado. O Git n√£o enviou a pasta src?"
          }

          # 3Ô∏è‚É£ Garantir NuGet Provider
          Write-Host "Configurando NuGet..."
          if (-not (Get-PackageProvider -Name NuGet -ErrorAction SilentlyContinue)) {
              Install-PackageProvider -Name NuGet -MinimumVersion 2.8.5.201 -Force
          }

          # 4Ô∏è‚É£ Garantir PSGallery registrada
          Write-Host "Configurando Reposit√≥rio..."
          Set-PSRepository -Name PSGallery -InstallationPolicy Trusted

          # 5Ô∏è‚É£ Publicar
          Write-Host "üöÄ Publicando m√≥dulo..."
          Publish-Module `
              -Path $modulePath `
              -NuGetApiKey $env:PSG_KEY `
              -Verbose `
              -Force

          Write-Host "‚úÖ Publica√ß√£o conclu√≠da!"