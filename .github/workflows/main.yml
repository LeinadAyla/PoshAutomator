name: CI-CD PoshAutomator
on:
  push:
    branches: [ main ]

jobs:
  test:
    name: Executar Testes Pester
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do c칩digo
        uses: actions/checkout@v4

      - name: Rodar Testes
        shell: pwsh
        run: |
          # 1. Instala o Pester se n칚o estiver presente
          Install-Module -Name Pester -Force -SkipPublisherCheck
          
          # 2. Executa os testes na pasta /tests
          $config = New-PesterConfiguration
          $config.Run.Path = "./tests"
          $config.Run.Exit = $true
          Invoke-Pester -Configuration $config

  publish:
    name: Publicar na PSGallery
    needs: test  # ESTA LINHA 칄 A CHAVE: S칩 publica se o job 'test' passar
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do c칩digo
        uses: actions/checkout@v4

      - name: Publicar Modulo
        shell: pwsh
        env:
          PSG_KEY: ${{ secrets.PSGALLERY_API_KEY }}
        run: |
          $ErrorActionPreference = "Stop"
          $modulePath = "./src/PoshAutomator"

          # 1. Configura칞칫es necess치rias para o ambiente Linux
          Install-PackageProvider -Name NuGet -MinimumVersion 2.8.5.201 -Force
          Set-PSRepository -Name PSGallery -InstallationPolicy Trusted

          # 2. Publica칞칚o Oficial
          Write-Host "游 Publicando vers칚o oficial ap칩s testes bem-sucedidos..."
          Publish-Module -Path $modulePath -NuGetApiKey $env:PSG_KEY -Verbose -Force