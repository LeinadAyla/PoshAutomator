name: Deploy PoshAutomator
on:
  push:
    branches: [ main ]

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: Publicar Modulo
        shell: pwsh
        env:
          # Garanta que o segredo no GitHub se chame EXATAMENTE PSGALLERY_API_KEY
          PSG_KEY: ${{ secrets.PSGALLERY_API_KEY }}
        run: |
          $ErrorActionPreference = "Stop"
          Write-Host "==== INICIANDO VALIDA√á√ÉO ===="

          # 1. Verificar se o Secret foi carregado
          if ([string]::IsNullOrWhiteSpace($env:PSG_KEY)) {
              Write-Error "ERRO: A vari√°vel PSG_KEY est√° vazia. Verifique os Secrets do seu reposit√≥rio!"
              exit 1
          }

          # 2. Definir o caminho correto baseado no seu 'tree'
          $modulePath = "./src/PoshAutomator"
          
          if (Test-Path $modulePath) {
              Write-Host "‚úÖ Pasta do m√≥dulo encontrada: $modulePath"
              Get-ChildItem -Path $modulePath
          } else {
              Write-Error "ERRO: Caminho $modulePath n√£o encontrado no reposit√≥rio!"
              exit 1
          }

          # 3. Publica√ß√£o Oficial
          Write-Host "üöÄ Publicando na PowerShell Gallery..."
          Publish-Module -Path $modulePath -NuGetApiKey $env:PSG_KEY -Verbose -Force