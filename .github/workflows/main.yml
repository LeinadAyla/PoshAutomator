name: Deploy PoshAutomator

on:
  push:
    branches: [ main ]

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: Publicar Modulo
        shell: pwsh
        env:
          PSG_KEY: ${{ secrets.PSGALLERY_API_KEY }}
        run: |
          $ErrorActionPreference = "Stop"

          Write-Host "==== DEBUG WORKSPACE ===="
          Get-Location
          Get-ChildItem -Recurse

          # 1Ô∏è‚É£ Validar Secret
          if ([string]::IsNullOrWhiteSpace($env:PSG_KEY)) {
              throw "ERRO: PSG_KEY est√° vazia. Verifique o Secret 'PSGALLERY_API_KEY' no GitHub."
          }

          # 2Ô∏è‚É£ Caminho do m√≥dulo
          $modulePath = "./src/PoshAutomator"
          if (-not (Test-Path $modulePath)) {
              throw "ERRO: Pasta $modulePath n√£o encontrada no reposit√≥rio!"
          }

          # 3Ô∏è‚É£ Validar manifesto (.psd1)
          $manifest = Get-ChildItem "$modulePath/*.psd1" -ErrorAction SilentlyContinue
          if (-not $manifest) {
              throw "ERRO: Nenhum arquivo .psd1 encontrado em $modulePath"
          } else {
              Write-Host "‚úÖ Manifesto encontrado: $($manifest.Name)"
          }

          # 4Ô∏è‚É£ Garantir NuGet Provider
          if (-not (Get-PackageProvider -Name NuGet -ErrorAction SilentlyContinue)) {
              Install-PackageProvider -Name NuGet -MinimumVersion 2.8.5.201 -Force
          }

          # 5Ô∏è‚É£ Garantir PSGallery registrada e confi√°vel
          if (-not (Get-PSRepository -Name PSGallery -ErrorAction SilentlyContinue)) {
              Register-PSRepository -Default
          }
          Set-PSRepository -Name PSGallery -InstallationPolicy Trusted

          # 6Ô∏è‚É£ Publica√ß√£o ‚Äì falha se n√£o funcionar
          Write-Host "üöÄ Tentando publicar m√≥dulo..."
          Publish-Module `
              -Path $modulePath `
              -NuGetApiKey $env:PSG_KEY `
              -Verbose `
              -Force

          Write-Host "‚úÖ Publica√ß√£o conclu√≠da com sucesso!"
