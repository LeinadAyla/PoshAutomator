name: CI-CD PoshAutomator

on:
  push:
    branches: [ main ]

jobs:
  test:
    name: Executar Testes Pester
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4
      - name: Rodar Testes
        shell: pwsh
        run: |
          Install-Module -Name Pester -Force -SkipPublisherCheck -Scope CurrentUser
          $config = New-PesterConfiguration
          $config.Run.Path = "./tests"
          $config.Run.Exit = $true
          Invoke-Pester -Configuration $config

  publish:
    name: Publicar na PSGallery
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4

      # ESTE Ã‰ O PASSO QUE FALTAVA: Prepara o terreno para o Publish-Module
      - name: Instalar .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Publicar na PSGallery
        shell: pwsh
        env:
          # Verifique se o nome do Secret no GitHub Ã© exatamente este:
          PSG_KEY: ${{ secrets.PSGALLERY_API_KEY }}
        run: |
          $ErrorActionPreference = "Stop"
          
          Write-Host "ðŸš€ Iniciando publicaÃ§Ã£o oficial via Publish-Module..."
          
          # Publica usando o comando nativo que agora tem o .NET para ajudar
          Publish-Module -Path "./src/PoshAutomator" -NuGetApiKey $env:PSG_KEY -Verbose